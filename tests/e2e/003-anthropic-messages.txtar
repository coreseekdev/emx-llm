# Test Anthropic-compatible messages endpoint

# Start gateway
exec emx-gate &
sleep 4s

# Test basic message
exec curl --noproxy "*" -s -X POST http://127.0.0.1:8848/v1/messages -H "Content-Type: application/json" -d '{"model":"anthropic.claude-3-opus-20240229","max_tokens":1024,"messages":[{"role":"user","content":"Hello"}]}'
stdout 'type'
stdout 'role'

# Test with multiple messages
exec curl --noproxy "*" -s -X POST http://127.0.0.1:8848/v1/messages -H "Content-Type: application/json" -d '{"model":"anthropic.claude-3-opus-20240229","max_tokens":1024,"messages":[{"role":"user","content":"Hello"},{"role":"assistant","content":"Hi there!"},{"role":"user","content":"How are you?"}]}'
stdout 'stop_reason'

# Clean up
[windows] ? exec powershell.exe -Command "Stop-Process -Name emx-gate -Force -ErrorAction SilentlyContinue"
[unix] ? exec pkill -f emx-gate
